# {{ ansible_managed }}

global
  # log logstash    local0 #Change logstash to your naming
  log /dev/log    local0
  log /dev/log    local1 notice
  #	log-send-hostname
  chroot /var/lib/haproxy
  user haproxy
  group haproxy
  daemon
  maxconn 40000
  spread-checks 3
  stats socket /run/haproxy/admin.sock mode 666 level admin

defaults
  log     global
  mode    tcp
  maxconn 40000
  option  httplog
  option  dontlognull
  option redispatch
  option tcp-smart-accept
  option tcp-smart-connect
  retries 3
  timeout queue 5000
  timeout connect 50000
  timeout client 50000
  timeout server 50000

{% if enable_haproxy_admin_page %}
userlist STATSUSERS
  group admin users admin
  user {{ haproxy_admin_user }} insecure-password {{ haproxy_admin_password }}

listen admin_page 0.0.0.0:{{ haproxy_admin_port }}
  mode http
  stats enable
  stats refresh 60s
  stats uri /
  acl AuthOkay_ReadOnly http_auth(STATSUSERS)
  acl AuthOkay_Admin http_auth_group(STATSUSERS) admin
  stats http-request auth realm admin_page unless AuthOkay_ReadOnly
{% endif %}

{% if haproxy_configs is defined %}
{%   for config in item.0 %}
listen {{ config.name }}-{{ config.proto|upper }}-{{ config.port_fe }} {{ keepalived_vip }}:{{ config.port_fe }}
  mode tcp
  option tcpka
  option tcplog
  balance {{ config.balance }}
  default-server inter 2s downinter 5s rise 3 fall 2 slowstart 60s maxconn 256 maxqueue 128 weight 100
{%     for host in groups.item.1 %}
  server {{ host }} {{ host }}:{{ config.port_be }} check
{%     endfor %}
{%   endfor %}
{% endif %}
